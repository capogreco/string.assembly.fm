<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>String Assembly FM - Controller</title>
        <link rel="stylesheet" href="./css/ctrl.css">
    </head>
    <body>
        <div class="main-wrapper">
            <div class="container">
            <div id="status">Disconnected</div>

            <div id="controller_warning" class="warning">
                ⚠️ Controller conflict detected - multiple controllers detected!
                <div
                    id="other_controllers"
                    style="font-size: 0.9em; margin-top: 5px"
                ></div>
                <button
                    id="kick_others"
                    style="
                        margin-top: 10px;
                        padding: 5px 15px;
                        background: #d32f2f;
                        color: white;
                        border: none;
                        border-radius: 3px;
                        cursor: pointer;
                    "
                >
                    Kick Other Controllers
                </button>
            </div>

            <div class="program-controls">
                <button id="send_current_program" disabled>Send Current Program</button>
                <span id="status_badge" class="status-badge synced"
                    >✓ Synced</span
                >
            </div>

            <div class="section">
                <div class="section-title">Chord & Expression Control</div>

                <div
                    class="chord-control"
                    style="
                        margin-bottom: 15px;
                        padding: 10px;
                        background: #262626;
                        border-radius: 8px;
                        border: 1px solid #374151;
                    "
                >
                    <strong style="color: #f1f5f9;">Current Chord: </strong
                    ><span id="chord-display" style="color: #60a5fa">None</span>
                    <button
                        id="clear-chord"
                        style="
                            float: right;
                            padding: 5px 15px;
                            background: #dc3545;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 14px;
                        "
                    >
                        Clear
                    </button>
                </div>

                <div
                    id="expression-display"
                    style="
                        margin-top: 15px;
                        padding: 15px;
                        background: #262626;
                        border-radius: 8px;
                        border: 1px solid #374151;
                    "
                >
                    <strong style="color: #f1f5f9;">Expression Display:</strong>
                    <div
                        id="expression-content"
                        style="
                            margin-top: 10px;
                            color: #9ca3af;
                            font-style: italic;
                        "
                    >
                        Click piano keys to add notes to chord
                    </div>
                </div>

                <div id="piano-container" style="margin: 10px 0">
                    <svg
                        id="piano"
                        width="100%"
                        height="80"
                        style="background: #fafafa"
                        xmlns="http://www.w3.org/2000/svg"
                    >
                        <!-- Piano keys will be generated by JavaScript -->
                    </svg>
                </div>

                <div class="expression-group vibrato">
                    <div class="expression-group-title">Vibrato Parameters</div>
                    <div class="control-group">
                        <label for="vibratoRate">Base Rate</label>
                        <input
                            type="range"
                            id="vibratoRate"
                            value="5.0"
                            min="0.0"
                            max="10.0"
                            step="0.1"
                        />
                        <span id="vibratoRateValue" class="value-display"
                            >5.0</span
                        >
                    </div>
                    <div class="control-group" style="margin-top: 15px">
                        <label>Vibrato Harmonic Ratios</label>
                        <div
                            class="harmonic-selector"
                            data-expression="vibrato"
                        >
                            <div class="harmonic-row" data-type="numerator">
                                <span
                                    class="harmonic-button selected"
                                    data-value="1"
                                    >1</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="2"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >2</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="3"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >3</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="4"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >4</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="5"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >5</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="6"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >6</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="7"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >7</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="8"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >8</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="9"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >9</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="10"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >10</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="11"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >11</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="12"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >12</span
                                >
                            </div>
                            <div class="harmonic-row" data-type="denominator">
                                <span
                                    class="harmonic-button selected"
                                    data-value="1"
                                    >1</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="2"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >2</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="3"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >3</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="4"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >4</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="5"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >5</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="6"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >6</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="7"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >7</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="8"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >8</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="9"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >9</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="10"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >10</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="11"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >11</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="12"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >12</span
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <div class="expression-group trill">
                    <div class="expression-group-title">Trill Parameters</div>

                    <div class="control-group">
                        <label for="trillArticulation">Articulation</label>
                        <input
                            type="range"
                            id="trillArticulation"
                            value="0.7"
                            min="0.1"
                            max="0.95"
                            step="0.01"
                        />
                        <span id="trillArticulationValue" class="value-display"
                            >0.70</span
                        >
                    </div>
                    <div class="control-group">
                        <label for="trillSpeed">Speed</label>
                        <input
                            type="range"
                            id="trillSpeed"
                            value="5.0"
                            min="3.0"
                            max="12.0"
                            step="0.1"
                        />
                        <span id="trillSpeedValue" class="value-display"
                            >5.0</span
                        >
                    </div>
                    <div class="control-group" style="margin-top: 15px">
                        <label>Trill Harmonic Ratios</label>
                        <div class="harmonic-selector" data-expression="trill">
                            <div class="harmonic-row" data-type="numerator">
                                <span
                                    class="harmonic-button selected"
                                    data-value="1"
                                    data-type="numerator"
                                    >1</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="2"
                                    data-type="numerator"
                                    >2</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="3"
                                    data-type="numerator"
                                    >3</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="4"
                                    data-type="numerator"
                                    >4</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="5"
                                    data-type="numerator"
                                    >5</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="6"
                                    data-type="numerator"
                                    >6</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="7"
                                    data-type="numerator"
                                    >7</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="8"
                                    data-type="numerator"
                                    >8</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="9"
                                    data-type="numerator"
                                    >9</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="10"
                                    data-type="numerator"
                                    >10</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="11"
                                    data-type="numerator"
                                    >11</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="12"
                                    data-type="numerator"
                                    >12</span
                                >
                            </div>
                            <div class="harmonic-row" data-type="denominator">
                                <span
                                    class="harmonic-button selected"
                                    data-value="1"
                                    data-type="denominator"
                                    >1</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="2"
                                    data-type="denominator"
                                    >2</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="3"
                                    data-type="denominator"
                                    >3</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="4"
                                    data-type="denominator"
                                    >4</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="5"
                                    data-type="denominator"
                                    >5</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="6"
                                    data-type="denominator"
                                    >6</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="7"
                                    data-type="denominator"
                                    >7</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="8"
                                    data-type="denominator"
                                    >8</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="9"
                                    data-type="denominator"
                                    >9</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="10"
                                    data-type="denominator"
                                    >10</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="11"
                                    data-type="denominator"
                                    >11</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="12"
                                    data-type="denominator"
                                    >12</span
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <div class="expression-group tremolo">
                    <div class="expression-group-title">Tremolo Parameters</div>
                    <div class="control-group">
                        <label for="tremoloArticulation">Articulation</label>
                        <input
                            type="range"
                            id="tremoloArticulation"
                            value="0.8"
                            min="0.1"
                            max="0.95"
                            step="0.01"
                        />
                        <span
                            id="tremoloArticulationValue"
                            class="value-display"
                            >0.80</span
                        >
                    </div>

                    <div class="control-group">
                        <label for="tremoloSpeed">Speed</label>
                        <input
                            type="range"
                            id="tremoloSpeed"
                            value="4.0"
                            min="1.0"
                            max="12.0"
                            step="0.1"
                        />
                        <span id="tremoloSpeedValue" class="value-display"
                            >4.0</span
                        >
                    </div>
                    <div class="control-group" style="margin-top: 15px">
                        <label>Tremolo Harmonic Ratios</label>
                        <div
                            class="harmonic-selector"
                            data-expression="tremolo"
                        >
                            <div class="harmonic-row" data-type="numerator">
                                <span
                                    class="harmonic-button selected"
                                    data-value="1"
                                    >1</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="2"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >2</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="3"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >3</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="4"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >4</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="5"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >5</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="6"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >6</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="7"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >7</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="8"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >8</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="9"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >9</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="10"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >10</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="11"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >11</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="12"
                                    data-type="numerator"
                                    data-type="numerator"
                                    >12</span
                                >
                            </div>
                            <div class="harmonic-row" data-type="denominator">
                                <span
                                    class="harmonic-button selected"
                                    data-value="1"
                                    >1</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="2"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >2</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="3"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >3</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="4"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >4</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="5"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >5</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="6"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >6</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="7"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >7</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="8"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >8</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="9"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >9</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="10"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >10</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="11"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >11</span
                                >
                                <span
                                    class="harmonic-button"
                                    data-value="12"
                                    data-type="denominator"
                                    data-type="denominator"
                                    >12</span
                                >
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Instrument</div>
                <div class="controls">
                    <div class="control-group">
                        <label for="bodyType">Body Type</label>
                        <select id="bodyType">
                            <option value="0">Violin</option>
                            <option value="1">Viola</option>
                            <option value="2">Cello</option>
                            <option value="3">Guitar</option>
                            <option value="4">None</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="stringMaterial">Material</label>
                        <select id="stringMaterial">
                            <option value="0">Steel</option>
                            <option value="1">Gut</option>
                            <option value="2">Nylon</option>
                            <option value="3">Wound</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="stringDamping">Damping</label>
                        <input
                            type="range"
                            id="stringDamping"
                            value="0.5"
                            min="0.01"
                            max="0.99"
                            step="0.01"
                        />
                        <span id="stringDampingValue" class="value-display"
                            >0.50</span
                        >
                    </div>
                    <div class="control-group">
                        <label for="brightness">Brightness</label>
                        <input
                            type="range"
                            id="brightness"
                            value="0.5"
                            min="0.0"
                            max="1.0"
                            step="0.01"
                        />
                        <span id="brightnessValue" class="value-display"
                            >0.50</span
                        >
                    </div>
                    <div class="control-group">
                        <label for="bodyResonance">Body Resonance</label>
                        <input
                            type="range"
                            id="bodyResonance"
                            value="0.3"
                            min="0.0"
                            max="1.0"
                            step="0.01"
                        />
                        <span id="bodyResonanceValue" class="value-display"
                            >0.30</span
                        >
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Bow Control</div>
                <div class="controls">
                    <div class="control-group">
                        <label for="bowForce">Force</label>
                        <input
                            type="range"
                            id="bowForce"
                            value="0.5"
                            min="0.0"
                            max="1.0"
                            step="0.01"
                        />
                        <span id="bowForceValue" class="value-display"
                            >0.50</span
                        >
                    </div>
                    <div class="control-group">
                        <label for="bowPosition">Position</label>
                        <input
                            type="range"
                            id="bowPosition"
                            value="0.12"
                            min="0.02"
                            max="0.5"
                            step="0.01"
                        />
                        <span id="bowPositionValue" class="value-display"
                            >0.12</span
                        >
                    </div>
                    <div class="control-group">
                        <label for="bowSpeed">Speed</label>
                        <input
                            type="range"
                            id="bowSpeed"
                            value="0.5"
                            min="0.0"
                            max="1.0"
                            step="0.01"
                        />
                        <span id="bowSpeedValue" class="value-display"
                            >0.50</span
                        >
                    </div>
                </div>
            </div>

            <hr class="separator" />

            <div class="section">
                <div class="section-title">Master Output</div>
                <div class="controls">
                    <div class="control-group">
                        <label for="masterGain">Volume</label>
                        <input
                            type="range"
                            id="masterGain"
                            value="0.5"
                            min="0.0"
                            max="1.0"
                            step="0.01"
                        />
                        <span id="masterGainValue" class="value-display"
                            >0.50</span
                        >
                    </div>
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="power" checked /> Power
                            On/Off
                        </label>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>

            <hr class="separator" />

            <div class="section">
                <div class="section-title">Program Banking</div>
                <div style="font-size: 0.8em; color: #666; margin-bottom: 10px; padding: 8px; background: #f0f0f0; border-radius: 4px;">
                    💡 <strong>Shift+1-9</strong> to save, <strong>1-9</strong> to load (0 = Bank 10)
                </div>
                <div class="banking-controls">
                    <label for="bank_selector">Bank:</label>
                    <select id="bank_selector">
                        <option value="1">Bank 1 ⚪</option>
                        <option value="2">Bank 2 ⚪</option>
                        <option value="3">Bank 3 ⚪</option>
                        <option value="4">Bank 4 ⚪</option>
                        <option value="5">Bank 5 ⚪</option>
                    </select>
                    <button id="save_bank">Save</button>
                    <button id="load_bank">Load</button>
                </div>
                <div style="font-size: 0.8em; color: #666; margin-top: 5px">
                    Banks store: Parameters + Harmonic Ratios + Chord +
                    Expressions
                </div>
            </div>

            <div id="synths">
                <h3>Connected Synths</h3>
                <div id="synth_list">None connected</div>
            </div>
        </div>
        
        <div class="transition-sidebar">
            <div id="stats" style="margin-bottom: 15px;">
                <div class="stat" style="display: flex; flex-direction: column; align-items: center;">
                    <strong id="connected_count" style="display: block; order: 1;">0</strong>
                    <span style="display: block; order: 2;">Connected</span>
                </div>
                <div class="stat" style="display: flex; flex-direction: column; align-items: center;">
                    <strong id="avg_latency" style="display: block; order: 1;">-</strong>
                    <span style="display: block; order: 2;">Avg Latency</span>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">Transition Control</div>
                <div class="controls">
                    <div class="control-group">
                        <label for="transitionDuration">Duration</label>
                        <input
                            type="range"
                            id="transitionDuration"
                            value="39"
                            min="0"
                            max="100"
                            step="1"
                        />
                        <span id="transitionDurationValue" class="value-display"
                            >1.0s</span
                        >
                    </div>
                    <div class="control-group">
                        <label for="transitionDurationSpread"
                            >Duration Spread</label
                        >
                        <input
                            type="range"
                            id="transitionDurationSpread"
                            value="0"
                            min="0"
                            max="100"
                            step="5"
                        />
                        <span
                            id="transitionDurationSpreadValue"
                            class="value-display"
                            >0%</span
                        >
                    </div>
                    <div class="control-group">
                        <label for="transitionStagger">Stagger</label>
                        <input
                            type="range"
                            id="transitionStagger"
                            value="0"
                            min="0"
                            max="100"
                            step="5"
                        />
                        <span id="transitionStaggerValue" class="value-display"
                            >0%</span
                        >
                    </div>
                </div>
            </div>
            
            <!-- Active Program Display -->
            <div class="section" style="margin-top: 20px; background: #1a1a1a; border-left-color: #4ade80;">
                <div class="section-title" style="color: #4ade80; border-bottom-color: #2d3748; font-size: 1em;">
                    Active Program
                </div>
                <div id="active-program-display" style="padding: 10px; text-align: center; font-family: monospace; font-size: 1.1em; color: #e2e8f0;">
                    <span style="color: #64748b;">No active program</span>
                </div>
            </div>
            
            <!-- Saved Banks Display -->
            <div class="section" style="margin-top: 20px; background: #1a1a1a; border-left-color: #3b82f6;">
                <div class="section-title" style="color: #60a5fa; border-bottom-color: #2d3748; position: relative;">
                    Saved Banks
                    <button id="clear-banks-btn" class="btn-small" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); padding: 2px 8px; font-size: 0.8em; background: #ff6b6b; color: white; border: none; border-radius: 3px; cursor: pointer; display: none; transition: background 0.2s;" 
                            onmouseover="this.style.background='#ff5252'" 
                            onmouseout="this.style.background='#ff6b6b'">
                        Clear All
                    </button>
                </div>
                <div id="saved-banks-display" style="font-size: 0.9em;">
                    <div style="color: #64748b; text-align: center; padding: 20px;">
                        No banks saved yet
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Load the module loader (handles modular vs legacy) -->
        <script src="./js/module-loader.js"></script>

        <!-- Include interactive expression and stochastic chord modules -->
        <script src="../src/dsp/svg_interactive_expression.js"></script>
        <script src="../src/common/standard_parameters.js"></script>
        <script type="module" src="./js/ctrl-main-logic.js"></script>
    </body>
</html>