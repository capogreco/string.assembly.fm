# WebRTC Remote Connection Failure - Bug Report

## Issue Summary
WebRTC connections between synth and controller clients fail when they are not on the same local network, despite having valid TURN servers configured and both clients successfully fetching ICE server configurations.

## Environment
- **Deployment**: Deno Deploy (edge deployment)
- **Signaling**: WebSocket with Deno KV for controller discovery
- **TURN Provider**: Twilio Network Traversal Service
- **Affected Clients**: index.html (synth), ctrl.html (controller)

## Observed Behavior

### Working Scenario
- Clients on the same local network can connect successfully
- Controller appears in the synth's controller list
- Data channels establish correctly

### Failing Scenario
- Clients on different networks cannot establish connection
- Controller is discovered (appears in WebSocket messages)
- WebRTC connection fails at ICE connection stage

## Diagnostic Findings

### 1. TURN Server Configuration ✅
- Both synth and controller fetch ICE servers from `/ice-servers` endpoint
- Server returns valid Twilio TURN credentials
- TURN servers tested independently and confirmed reachable
- ICE server configuration includes: STUN, TURN, TURN, TURN

### 2. ICE Candidate Generation ✅
- Synth generates 9 total candidates
- Candidate types include: HOST, SRFLX, RELAY, OTHER
- RELAY candidates are successfully generated (Has RELAY: ✅)

### 3. Signaling Exchange ✅
All signaling phases complete successfully:
- ✅ Controller discovered
- ✅ ICE servers loaded (with TURN)
- ✅ Offer created
- ✅ Offer sent
- ✅ Answer received
- ✅ ICE gathering complete
- ✅ ICE candidates sent
- ✅ ICE candidates received
- ❌ Connection established (fails here)

### 4. ICE Connection Failure Details
- **Total candidate pairs attempted**: 28
- **Successful pairs**: 0
- **Failed pairs**: 28
- **RELAY pairs attempted**: 21
- **ICE State**: failed
- **Likely reason**: TURN auth failed or server unreachable

## Key Observations

1. **TURN is being used**: 21 out of 28 candidate pairs used RELAY, confirming TURN servers are being utilized
2. **Complete failure**: Not a single candidate pair succeeded, suggesting a systematic issue
3. **Both sides configured**: Server logs confirm both synth and controller fetch ICE servers
4. **Valid credentials**: TURN server test passed when tested independently

## Potential Root Causes

### 1. TURN Token Timing Issue
- Twilio TURN tokens have limited TTL (typically 24 hours)
- Possible token expiration between fetch and use
- Tokens might be cached differently on each client

### 2. ICE Configuration Mismatch
- Controller might be using cached/stale ICE configuration
- Possible race condition in controller's WebRTC setup

### 3. Data Channel Configuration
- Synth creates data channel named "data"
- Controller expects data channel via `ondatachannel` event
- Possible protocol or configuration mismatch

### 4. Network-Specific Issues
- Corporate firewall blocking TURN TCP/UDP ports
- Deep packet inspection interfering with WebRTC
- NAT type incompatibility despite TURN

## Recommended Next Steps

1. **Add TURN verification on controller side**
   - Log ICE candidates generated by controller
   - Verify controller is generating RELAY candidates

2. **Check ICE gathering timing**
   - Ensure both peers have TURN config before creating offers/answers
   - Add delay or synchronization mechanism

3. **Test with public TURN server**
   - Rule out Twilio-specific issues
   - Try with known-good public TURN like `turn:openrelay.metered.ca:80`

4. **Enable verbose WebRTC logging**
   - Set `webrtc.enableDiagnosticLogs = true` in WebRTCManager
   - Check browser console for detailed ICE negotiation logs

5. **Verify controller's RELAY candidates**
   - Add logging to see what candidate types controller sends
   - Ensure bidirectional RELAY capability

## Code Locations

- **Synth WebRTC**: `/public/js/apps/synth-app.js:341-628`
- **Controller WebRTC**: `/public/js/modules/network/WebRTCManager.js`
- **Server signaling**: `/src/server/server.ts`
- **ICE server fetch**: `/public/js/config/system.config.js:fetchIceServers()`

## Current Workarounds
- Use clients on same local network
- Deploy controller on publicly accessible server
- Use VPN to simulate local network

## Additional Notes
- Issue occurs consistently across different remote networks
- Local network connections work reliably
- Signaling via Deno KV works correctly for discovery
- WebSocket messaging is functioning properly